<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>冯手力-java学习之路</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.49d708b7.css" as="style"><link rel="preload" href="/assets/js/app.6c5e603f.js" as="script"><link rel="preload" href="/assets/js/2.b8f1ea19.js" as="script"><link rel="preload" href="/assets/js/1.1af8b773.js" as="script"><link rel="preload" href="/assets/js/105.fe40214d.js" as="script"><link rel="prefetch" href="/assets/js/10.d6964b40.js"><link rel="prefetch" href="/assets/js/100.1b616e3b.js"><link rel="prefetch" href="/assets/js/101.6bc9d2f1.js"><link rel="prefetch" href="/assets/js/102.4f99e9b3.js"><link rel="prefetch" href="/assets/js/103.270d256a.js"><link rel="prefetch" href="/assets/js/104.3274b0f0.js"><link rel="prefetch" href="/assets/js/106.b08008dd.js"><link rel="prefetch" href="/assets/js/107.81ceb492.js"><link rel="prefetch" href="/assets/js/108.7f3782ea.js"><link rel="prefetch" href="/assets/js/109.4df37ea0.js"><link rel="prefetch" href="/assets/js/11.56a4474e.js"><link rel="prefetch" href="/assets/js/110.8c703746.js"><link rel="prefetch" href="/assets/js/111.7d46bfb3.js"><link rel="prefetch" href="/assets/js/112.177fe44f.js"><link rel="prefetch" href="/assets/js/113.7d52ffa6.js"><link rel="prefetch" href="/assets/js/114.d17a0e2a.js"><link rel="prefetch" href="/assets/js/115.1abd4e94.js"><link rel="prefetch" href="/assets/js/116.0c8a021c.js"><link rel="prefetch" href="/assets/js/117.575e045f.js"><link rel="prefetch" href="/assets/js/12.0c011ecf.js"><link rel="prefetch" href="/assets/js/13.8e76ac17.js"><link rel="prefetch" href="/assets/js/14.3442fe62.js"><link rel="prefetch" href="/assets/js/15.aef2c212.js"><link rel="prefetch" href="/assets/js/16.92659c9d.js"><link rel="prefetch" href="/assets/js/17.fc315ab5.js"><link rel="prefetch" href="/assets/js/18.beeb9172.js"><link rel="prefetch" href="/assets/js/19.c0c5241d.js"><link rel="prefetch" href="/assets/js/20.502b9ef7.js"><link rel="prefetch" href="/assets/js/21.81c84a41.js"><link rel="prefetch" href="/assets/js/22.23d552a1.js"><link rel="prefetch" href="/assets/js/23.05443e4f.js"><link rel="prefetch" href="/assets/js/24.3d9e8ea7.js"><link rel="prefetch" href="/assets/js/25.2944a470.js"><link rel="prefetch" href="/assets/js/26.971125bf.js"><link rel="prefetch" href="/assets/js/27.9ff2991f.js"><link rel="prefetch" href="/assets/js/28.e9b64d19.js"><link rel="prefetch" href="/assets/js/29.50684719.js"><link rel="prefetch" href="/assets/js/3.84eef86b.js"><link rel="prefetch" href="/assets/js/30.1ed800a1.js"><link rel="prefetch" href="/assets/js/31.5cad921e.js"><link rel="prefetch" href="/assets/js/32.c36a9eda.js"><link rel="prefetch" href="/assets/js/33.35f101f2.js"><link rel="prefetch" href="/assets/js/34.ba7c1125.js"><link rel="prefetch" href="/assets/js/35.635f5bc6.js"><link rel="prefetch" href="/assets/js/36.859af87f.js"><link rel="prefetch" href="/assets/js/37.cd71c96d.js"><link rel="prefetch" href="/assets/js/38.b420553c.js"><link rel="prefetch" href="/assets/js/39.955712b3.js"><link rel="prefetch" href="/assets/js/4.cb2a34ab.js"><link rel="prefetch" href="/assets/js/40.c2adf941.js"><link rel="prefetch" href="/assets/js/41.863ceefc.js"><link rel="prefetch" href="/assets/js/42.eaef8043.js"><link rel="prefetch" href="/assets/js/43.8c5b1e4e.js"><link rel="prefetch" href="/assets/js/44.7ecdf9f4.js"><link rel="prefetch" href="/assets/js/45.0d777c7f.js"><link rel="prefetch" href="/assets/js/46.4bc7018e.js"><link rel="prefetch" href="/assets/js/47.4808e6c1.js"><link rel="prefetch" href="/assets/js/48.2ac0f400.js"><link rel="prefetch" href="/assets/js/49.c8e5b662.js"><link rel="prefetch" href="/assets/js/5.2f36fdc6.js"><link rel="prefetch" href="/assets/js/50.8eb84c36.js"><link rel="prefetch" href="/assets/js/51.05b58396.js"><link rel="prefetch" href="/assets/js/52.590078d1.js"><link rel="prefetch" href="/assets/js/53.7c196537.js"><link rel="prefetch" href="/assets/js/54.282fb6bb.js"><link rel="prefetch" href="/assets/js/55.fda86f28.js"><link rel="prefetch" href="/assets/js/56.9fd6a89a.js"><link rel="prefetch" href="/assets/js/57.c5835606.js"><link rel="prefetch" href="/assets/js/58.675ee342.js"><link rel="prefetch" href="/assets/js/59.72eb935d.js"><link rel="prefetch" href="/assets/js/6.f4b9502c.js"><link rel="prefetch" href="/assets/js/60.b45e2e5d.js"><link rel="prefetch" href="/assets/js/61.9e3bd166.js"><link rel="prefetch" href="/assets/js/62.1640ea02.js"><link rel="prefetch" href="/assets/js/63.c15c0da6.js"><link rel="prefetch" href="/assets/js/64.4bf69ae9.js"><link rel="prefetch" href="/assets/js/65.3868c7fb.js"><link rel="prefetch" href="/assets/js/66.30193f3f.js"><link rel="prefetch" href="/assets/js/67.3f386b86.js"><link rel="prefetch" href="/assets/js/68.0ce44a08.js"><link rel="prefetch" href="/assets/js/69.1a1e4714.js"><link rel="prefetch" href="/assets/js/7.627efd94.js"><link rel="prefetch" href="/assets/js/70.d9c49701.js"><link rel="prefetch" href="/assets/js/71.7611e605.js"><link rel="prefetch" href="/assets/js/72.24b470d7.js"><link rel="prefetch" href="/assets/js/73.c9fa5e1e.js"><link rel="prefetch" href="/assets/js/74.152dc7fc.js"><link rel="prefetch" href="/assets/js/75.c7193a1a.js"><link rel="prefetch" href="/assets/js/76.881a5c6f.js"><link rel="prefetch" href="/assets/js/77.ebaf76f2.js"><link rel="prefetch" href="/assets/js/78.345243e4.js"><link rel="prefetch" href="/assets/js/79.120ba98f.js"><link rel="prefetch" href="/assets/js/80.945d1ae6.js"><link rel="prefetch" href="/assets/js/81.86223b7e.js"><link rel="prefetch" href="/assets/js/82.a596d743.js"><link rel="prefetch" href="/assets/js/83.cd423350.js"><link rel="prefetch" href="/assets/js/84.91a9be10.js"><link rel="prefetch" href="/assets/js/85.11cbb34e.js"><link rel="prefetch" href="/assets/js/86.c2f2ec90.js"><link rel="prefetch" href="/assets/js/87.e3b789c2.js"><link rel="prefetch" href="/assets/js/88.0a7daaf4.js"><link rel="prefetch" href="/assets/js/89.44beca25.js"><link rel="prefetch" href="/assets/js/90.1e2f8dea.js"><link rel="prefetch" href="/assets/js/91.73527e37.js"><link rel="prefetch" href="/assets/js/92.5ace34ab.js"><link rel="prefetch" href="/assets/js/93.44510aa2.js"><link rel="prefetch" href="/assets/js/94.46e945e5.js"><link rel="prefetch" href="/assets/js/95.9c18c465.js"><link rel="prefetch" href="/assets/js/96.25c0d02f.js"><link rel="prefetch" href="/assets/js/97.9b757bc5.js"><link rel="prefetch" href="/assets/js/98.8fead16f.js"><link rel="prefetch" href="/assets/js/99.3604504a.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.c02eb734.js">
    <link rel="stylesheet" href="/assets/css/0.styles.49d708b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">冯手力-java学习之路</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/操作/" class="nav-link">
  操作
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="经验" class="dropdown-title"><span class="title">经验</span> <span class="arrow down"></span></button> <button type="button" aria-label="经验" class="mobile-dropdown-title"><span class="title">经验</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/工作经验/" class="nav-link">
  工作经验
</a></li><li class="dropdown-item"><!----> <a href="/项目经验/" class="nav-link">
  项目经验
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术相关" class="dropdown-title"><span class="title">技术相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术相关" class="mobile-dropdown-title"><span class="title">技术相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          java技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/" class="nav-link">
  java
</a></li><li class="dropdown-subitem"><a href="https://github.com/hehonghui/mockito-doc-zh#0" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mockito
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://blog.csdn.net/xiao__jia__jia/article/details/115252780" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mockito详解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><!----> <a href="/数据库/" class="nav-link">
  数据库技术
</a></li></ul></div></div><div class="nav-item"><a href="/架构之路/" class="nav-link">
  架构之路
</a></div><div class="nav-item"><a href="/领域驱动设计/" class="nav-link">
  领域驱动设计
</a></div><div class="nav-item"><a href="/源码解析/" class="nav-link">
  源码解析
</a></div><div class="nav-item"><a href="/程序员英语/" class="nav-link">
  程序员英语
</a></div><div class="nav-item"><a href="/面试突击班/" class="nav-link">
  面试突击班
</a></div><div class="nav-item"><a href="/算法体系/" class="nav-link">
  算法体系
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="下拉目录测试" class="dropdown-title"><span class="title">下拉目录测试</span> <span class="arrow down"></span></button> <button type="button" aria-label="下拉目录测试" class="mobile-dropdown-title"><span class="title">下拉目录测试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/ts/" class="nav-link">
  具体.md文档
</a></li><li class="dropdown-item"><!----> <a href="/guide/vue/test03.html" class="nav-link">
  文件夹下Readme
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  其他连接测试-百度链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/用友/" class="nav-link">
  用友
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/操作/" class="nav-link">
  操作
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="经验" class="dropdown-title"><span class="title">经验</span> <span class="arrow down"></span></button> <button type="button" aria-label="经验" class="mobile-dropdown-title"><span class="title">经验</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/工作经验/" class="nav-link">
  工作经验
</a></li><li class="dropdown-item"><!----> <a href="/项目经验/" class="nav-link">
  项目经验
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术相关" class="dropdown-title"><span class="title">技术相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术相关" class="mobile-dropdown-title"><span class="title">技术相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          java技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/" class="nav-link">
  java
</a></li><li class="dropdown-subitem"><a href="https://github.com/hehonghui/mockito-doc-zh#0" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mockito
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://blog.csdn.net/xiao__jia__jia/article/details/115252780" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mockito详解
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><!----> <a href="/数据库/" class="nav-link">
  数据库技术
</a></li></ul></div></div><div class="nav-item"><a href="/架构之路/" class="nav-link">
  架构之路
</a></div><div class="nav-item"><a href="/领域驱动设计/" class="nav-link">
  领域驱动设计
</a></div><div class="nav-item"><a href="/源码解析/" class="nav-link">
  源码解析
</a></div><div class="nav-item"><a href="/程序员英语/" class="nav-link">
  程序员英语
</a></div><div class="nav-item"><a href="/面试突击班/" class="nav-link">
  面试突击班
</a></div><div class="nav-item"><a href="/算法体系/" class="nav-link">
  算法体系
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="下拉目录测试" class="dropdown-title"><span class="title">下拉目录测试</span> <span class="arrow down"></span></button> <button type="button" aria-label="下拉目录测试" class="mobile-dropdown-title"><span class="title">下拉目录测试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/ts/" class="nav-link">
  具体.md文档
</a></li><li class="dropdown-item"><!----> <a href="/guide/vue/test03.html" class="nav-link">
  文件夹下Readme
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  其他连接测试-百度链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/用友/" class="nav-link">
  用友
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/%E9%9D%A2%E8%AF%95%E7%AA%81%E5%87%BB%E7%8F%AD/" aria-current="page" class="sidebar-link">面试突击</a></li><li><a href="/面试突击班/面试表达.html" class="sidebar-link">面试表达</a></li><li><a href="/面试突击班/基础面试题.html" class="sidebar-link">基础面试题</a></li><li><a href="/面试突击班/多线程与IO.html" class="sidebar-link">多线程与IO</a></li><li><a href="/面试突击班/Mysql.html" class="sidebar-link">Mysql</a></li><li><a href="/面试突击班/Mysql2024-下.html" class="sidebar-link">MySQL2024-下</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>问题背景</strong> ：</p> <p>某电商Saas平台的订单表 <code>orders</code> 数据量达到500万条，用户反馈分页查询订单时，翻页到第100页后响应时间超过5秒，严重影响用户体验。数据库版本为MySQL 8.0，表引擎为InnoDB。这里大致给大家演示，大家心里有就好</p> <p><strong>检查步骤</strong></p> <ol><li><strong>表结构与索引检查</strong> ：</li></ol> <div class="language- extra-class"><pre class="language-text"><code>-- 表结构
CREATE TABLE orders (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT,
  order_time DATETIME,
  amount DECIMAL(10,2),
  status TINYINT,
  product_id INT,
  INDEX idx_user_id (user_id)
);
</code></pre></div><ul><li>问题：分页查询基于 <code>order_time</code> 排序，但缺少 <code>(order_time, user_id)</code> 的联合索引。</li> <li>现有索引仅覆盖 <code>user_id</code>，无法高效支持排序和分页。</li></ul> <ol start="2"><li><strong>慢查询日志分析：</strong></li></ol> <div class="language- extra-class"><pre class="language-text"><code>-- SQL
SELECT * FROM orders
WHERE user_id = 1001
ORDER BY order_time DESC
LIMIT 100000, 20; -- 翻页到第5000页时需跳过10万条记录
</code></pre></div><p>EXPLAIN 结果显示：type=ALL（全表扫描），Extra=Using filesort（文件排序）。</p> <p>性能瓶颈定位：</p> <p>全表扫描：由于未命中覆盖索引，需要回表查询所有字段。</p> <p>文件排序：ORDER BY 未利用索引排序。</p> <p>高Offset分页：LIMIT 100000, 20 需要扫描前100000+20条记录，效率极低。</p> <h4 id="优化方案"><a href="#优化方案" class="header-anchor">#</a> <strong>优化方案</strong> ：</h4> <ol><li><p><strong>添加联合索引</strong> ：</p> <div class="language- extra-class"><pre class="language-text"><code>ALTER TABLE orders ADD INDEX idx_order_time_user_id (order_time DESC, user_id);
</code></pre></div><ul><li>覆盖 <code>ORDER BY order_time DESC, user_id</code> 的排序需求，避免文件排序。</li> <li>减少回表次数（若查询字段在索引中）。</li></ul></li> <li><p><strong>优化SQL写法（延迟关联）</strong> ：</p> <div class="language- extra-class"><pre class="language-text"><code>SELECT o.* 
FROM orders o
JOIN (
  SELECT id 
  FROM orders 
  WHERE user_id = 1001
  ORDER BY order_time DESC
  LIMIT 100000, 20
) AS tmp ON o.id = tmp.id;
</code></pre></div><ul><li>子查询先通过覆盖索引快速定位主键，再通过主键关联回表，减少数据扫描量。</li></ul></li> <li><p><strong>分页优化（游标分页）</strong> ：</p> <div class="language- extra-class"><pre class="language-text"><code>-- 记录上一页最后一条记录的order_time和id
SELECT * FROM orders
WHERE user_id = 1001
  AND (order_time &lt; '2023-10-01 12:00:00' OR (order_time = '2023-10-01 12:00:00' AND id &lt; 12345))
ORDER BY order_time DESC, id DESC
LIMIT 20;
</code></pre></div><ul><li>避免高Offset，通过游标（上一页的最后一条记录的排序字段值）定位下一页起始位置。</li></ul></li> <li><p><strong>业务层优化</strong> ：</p> <ul><li>限制用户最大翻页深度（如最多100页），引导通过搜索或过滤缩小范围。</li> <li>异步加载或缓存热门数据。</li></ul></li></ol> <hr> <h4 id="优化效果"><a href="#优化效果" class="header-anchor">#</a> <strong>优化效果</strong> ：</h4> <ul><li>查询时间从5秒降至50毫秒内。</li> <li><code>EXPLAIN</code> 显示：<code>type=range</code>（索引范围扫描），<code>Extra=Using index</code>（覆盖索引）。</li></ul> <h4 id="面试官提问"><a href="#面试官提问" class="header-anchor">#</a> <strong>面试官提问</strong> ：</h4> <blockquote><p>&quot;请描述一个你解决的MySQL性能优化案例，并说明你的思路和结果。&quot;</p></blockquote> <h4 id="回答模板"><a href="#回答模板" class="header-anchor">#</a> <strong>回答模板</strong> ：</h4> <ol><li><strong>问题背景</strong> ：
&quot;我曾在电商平台优化过一个订单分页查询的性能问题。当数据量达到500万时，翻页到深页码（如第100页）时响应时间超过5秒。&quot;</li> <li><strong>分析过程</strong> ：
<ul><li>检查表结构和索引，发现缺少支持排序和分页的联合索引。</li> <li>通过慢查询日志和 <code>EXPLAIN</code>确认全表扫描和文件排序问题。</li> <li>定位到高Offset分页导致大量无效数据扫描。&quot;</li></ul></li> <li><strong>优化方案</strong> ：
<ul><li>添加 <code>(order_time, user_id)</code>的联合索引，覆盖排序和查询条件。</li> <li>使用延迟关联技术，通过子查询先定位主键再回表，减少数据扫描量。</li> <li>引入游标分页替代传统分页，避免高Offset问题。</li> <li>业务层限制最大翻页深度。&quot;</li></ul></li> <li><strong>结果与总结</strong> ：
<ul><li>优化后查询时间从5秒降至50毫秒，用户体验显著提升。</li> <li>总结：索引设计需贴合查询模式，深分页需避免高Offset，业务逻辑与数据库优化需协同。&quot;</li></ul></li></ol> <h3 id="mysql索引失效性能优化案例"><a href="#mysql索引失效性能优化案例" class="header-anchor">#</a> MySQL索引失效性能优化案例</h3> <h4 id="案例背景"><a href="#案例背景" class="header-anchor">#</a> <strong>案例背景</strong> ：</h4> <p>某社交平台的用户表 <code>users</code> 数据量增长至1000万条后，用户反馈根据“昵称”搜索时（如模糊查询 <code>LIKE '%小明%'</code>），查询耗时从毫秒级增至10秒以上。表引擎为InnoDB，已有索引如下：</p> <div class="language- extra-class"><pre class="language-text"><code>CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  nickname VARCHAR(50),
  age INT,
  city VARCHAR(20),
  created_at DATETIME,
  INDEX idx_nickname (nickname)
);
</code></pre></div><hr> <h4 id="问题分析步骤"><a href="#问题分析步骤" class="header-anchor">#</a> <strong>问题分析步骤</strong> ：</h4> <ol><li><p><strong>慢查询定位</strong> ：</p> <div class="language- extra-class"><pre class="language-text"><code>-- 问题SQL
SELECT * FROM users 
WHERE nickname LIKE '%小明%' 
ORDER BY created_at DESC 
LIMIT 20;
</code></pre></div><ul><li>用户频繁使用模糊搜索昵称，响应时间超过10秒。</li></ul></li> <li><p><strong>执行计划分析</strong> ：</p> <div class="language- extra-class"><pre class="language-text"><code>EXPLAIN SELECT * FROM users WHERE nickname LIKE '%小明%';
</code></pre></div><ul><li>结果：<code>type=ALL</code>（全表扫描），<code>key=NULL</code>（未使用索引），<code>rows=10,000,000</code>。</li></ul></li> <li><p><strong>索引失效原因</strong> ：</p> <ul><li><strong>左模糊匹配</strong> ：<code>LIKE '%小明%'</code> 导致索引失效（B+树无法利用前缀匹配）。</li> <li><strong>排序与索引不匹配</strong> ：<code>ORDER BY created_at</code> 未在索引中，触发文件排序（<code>Using filesort</code>）。</li> <li><strong>回表开销</strong> ：即使使用索引，仍需回表查询所有字段。</li></ul></li></ol> <hr> <h4 id="优化方案-2"><a href="#优化方案-2" class="header-anchor">#</a> <strong>优化方案</strong> ：</h4> <ol><li><p><strong>使用全文索引:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>-- 添加全文索引
ALTER TABLE users ADD FULLTEXT INDEX ft_nickname (nickname);

-- 优化后SQL
SELECT * FROM users 
WHERE MATCH(nickname) AGAINST('+小明' IN BOOLEAN MODE)
ORDER BY created_at DESC 
LIMIT 20;
</code></pre></div><ul><li><strong>优势</strong> ：全文索引支持任意位置的文本匹配，避免左模糊问题。</li> <li><strong>限制</strong> ：需处理停用词，且中文需配合分词插件（如ngram）。</li></ul></li> <li><p><strong>覆盖索引优化（若无法使用全文索引）</strong> ：</p> <div class="language- extra-class"><pre class="language-text"><code>-- 新增联合索引（覆盖查询和排序字段）
ALTER TABLE users ADD INDEX idx_nickname_created_at (nickname, created_at);

-- 强制右模糊查询
SELECT * FROM users 
WHERE nickname LIKE '小明%'  -- 仅右模糊可利用B+树索引
ORDER BY created_at DESC 
LIMIT 20;
</code></pre></div><ul><li><strong>妥协点</strong> ：牺牲左模糊能力，仅支持前缀匹配。</li></ul></li> <li><p><strong>业务层调整</strong> ：</p> <ul><li>限制模糊搜索的最小字符长度（如至少3个字）。</li> <li>引入Elasticsearch等搜索引擎，实现高效全文检索。</li></ul></li></ol> <hr> <h4 id="优化效果-2"><a href="#优化效果-2" class="header-anchor">#</a> <strong>优化效果</strong> ：</h4> <ul><li>使用全文索引后，查询时间从10秒降至100毫秒内。</li> <li><code>EXPLAIN</code> 显示：<code>type=fulltext</code>（全文索引扫描），<code>Extra=Using where; Using filesort</code>（仍需优化排序）。</li> <li>若结合覆盖索引和游标分页，可进一步消除文件排序。</li></ul> <p>最好是使用搜索引擎，但是这里不使用搜索引擎的原因有两个，第一个是数据量不够，第二个是添加ES要增加额外的架构复杂度，并且这里没有聚合的需求，并且项目</p> <h3 id="面试回答技巧"><a href="#面试回答技巧" class="header-anchor">#</a> <strong>面试回答技巧</strong></h3> <h4 id="面试官提问-2"><a href="#面试官提问-2" class="header-anchor">#</a> <strong>面试官提问</strong> ：</h4> <blockquote><p>&quot;请举例说明你遇到的MySQL索引失效场景，以及如何解决的。&quot;</p></blockquote> <h4 id="回答模板-2"><a href="#回答模板-2" class="header-anchor">#</a> <strong>回答模板</strong> ：</h4> <ol><li><strong>问题背景</strong> ：
&quot;在社交平台的用户模糊搜索功能中，当用户量达到千万级时，<code>LIKE '%xxx%'</code>查询性能急剧下降。原因为 <code>nickname</code>字段的普通B+树索引因左模糊失效，导致全表扫描。&quot;</li> <li><strong>分析过程</strong> ：
<ul><li>通过 <code>EXPLAIN</code>确认索引未命中，发现 <code>type=ALL</code>和 <code>Using filesort</code>。</li> <li>定位到 <code>LIKE</code>左模糊是核心问题，B+树索引无法支持随机字符串匹配。</li> <li>评估是否可通过业务调整将左模糊改为右模糊（如搜索日志场景）。&quot;</li></ul></li> <li><strong>优化方案</strong> ：
<ul><li><strong>短期方案</strong> ：添加全文索引（<code>FULLTEXT</code>），利用倒排索引加速任意位置匹配。</li> <li><strong>长期方案</strong> ：引入Elasticsearch，专用于复杂搜索场景，并同步数据。</li> <li><strong>业务妥协</strong> ：限制模糊搜索的最小输入长度，减少无效请求。&quot;</li></ul></li> <li><strong>结果与总结</strong> ：
<ul><li>全文索引使查询耗时从10秒降至100毫秒，但中文分词需配置ngram插件。</li> <li>核心教训：B+树索引仅适合前缀匹配，复杂文本搜索需结合专用工具。</li> <li>后续通过ES实现了更灵活的搜索功能（如拼音搜索、同义词）。&quot;</li></ul></li></ol> <hr> <h4 id="加分点"><a href="#加分点" class="header-anchor">#</a> <strong>加分点</strong> ：</h4> <ul><li><strong>原理深入</strong> ：解释B+树索引的层序遍历机制，说明左模糊为何破坏前缀匹配。</li> <li><strong>扩展方案</strong> ：
<ul><li>提到 <code>INNODB_FT_DEFAULT_STOPWORD</code>处理停用词。</li> <li>使用 <code>ngram_token_size</code>调整中文分词粒度。</li></ul></li> <li><strong>权衡思考</strong> ：
<ul><li>全文索引的存储开销与写入性能影响。</li> <li>业务是否接受“右模糊”的体验差异（如仅允许搜索“前缀”）。</li></ul></li></ul> <p>话术：</p> <p>我曾经做过一个电商的Saas平台，需求是我们的平台的订单表 <code>orders</code> 数据量达到500万条，用户反馈分页查询订单时，翻页到第100页后响应时间超过5秒，严重影响用户体验。</p> <p><strong>我最开始去排查的时候，检查表结构以及索引，发现缺少支持排序和分页的正常索引，并且由于数据偏移量较大，所以导致我们的项目没有正常使用到user_id的索引，通过由于没有正常的需求把控，导致用户可以随意的操作页数，进而倒置高偏移量查询，导致扫描了大量的无效数据，</strong></p> <p><strong>我们经过讨论，确定了优化的方案，添加联合索引，将查询字段以及条件字段做为联合索引覆盖排序以及查询条件，使用了延迟关联的技术，通过子查询先定位主键再进行回表，减少数据扫描量，引入了游标分页的方式替代传统分页的方式，避免了高偏移量，并且辅助业务进行最大翻页深度的限制，</strong></p> <p><strong>优化之后，我们的查询时间从5S降低到50ms，4用户反馈体验显著提升</strong></p> <hr> <h4 id="常见索引失效场景归纳-面试备用"><a href="#常见索引失效场景归纳-面试备用" class="header-anchor">#</a> <strong>常见索引失效场景归纳（面试备用）</strong> ：</h4> <table><thead><tr><th><strong>场景</strong></th> <th><strong>示例</strong></th> <th><strong>解决方案</strong></th></tr></thead> <tbody><tr><td>左模糊查询</td> <td><code>LIKE '%abc'</code></td> <td>全文索引、右模糊、ES</td></tr> <tr><td>对索引列使用函数/表达式</td> <td><code>WHERE YEAR(create_time)=2023</code></td> <td>改用范围查询（<code>BETWEEN</code>）</td></tr> <tr><td>隐式类型转换</td> <td><code>WHERE id = '100'</code>（id为INT）</td> <td>确保类型一致</td></tr> <tr><td>OR条件部分无索引</td> <td><code>WHERE a=1 OR b=2</code>（b无索引）</td> <td>为b添加索引，或改用UNION</td></tr> <tr><td>联合索引跳过最左列</td> <td>索引 <code>(a,b)</code>，查询 <code>WHERE b=2</code></td> <td>调整索引顺序或补充条件（如 <code>a IN(...)</code>）</td></tr></tbody></table> <hr> <p>通过此案例，不仅能展示对索引机制的深刻理解，还能体现从技术到业务的综合优化能力，这在面试中会极具说服力。</p> <h3 id="实际项目场景-高并发电商订单系统-雪花算法id与mysql结合的业务问题"><a href="#实际项目场景-高并发电商订单系统-雪花算法id与mysql结合的业务问题" class="header-anchor">#</a> 实际项目场景：<strong>高并发电商订单系统 （雪花算法id与mysql结合的业务问题 ）</strong></h3> <hr> <h4 id="业务背景"><a href="#业务背景" class="header-anchor">#</a> <strong>业务背景</strong></h4> <p>某电商平台日订单量超过  <strong>1000 万</strong> ，订单数据需分库分表存储（分 16 个库，每个库 64 张表）。系统采用雪花算法生成订单 ID（主键），但在以下环节出现性能问题：</p> <ol><li><strong>写入性能下降</strong> ：高并发下索引页频繁分裂，导致插入延迟。</li> <li><strong>分页查询卡顿</strong> ：用户查看历史订单时，<code>LIMIT 1000000, 10</code> 查询耗时超过 3 秒。</li> <li><strong>时间范围查询低效</strong> ：运营需按时间筛选订单，但直接解析雪花 ID 时间戳导致全表扫描。</li> <li><strong>分库分表后 ID 冲突</strong> ：某次扩容后，因 <code>worker_id</code> 分配重复，导致多个分片生成重复 ID。</li></ol> <p>优化方案：</p> <h5 id="_1-写入性能优化-索引分裂问题"><a href="#_1-写入性能优化-索引分裂问题" class="header-anchor">#</a> <strong>1. 写入性能优化（索引分裂问题）</strong></h5> <p><strong>问题分析</strong>
雪花 ID 在同一毫秒内局部乱序（如不同节点生成的 ID 交叉插入），导致主键索引页频繁分裂，写入性能下降。</p> <p><strong>解决方案</strong></p> <ul><li><p><strong>主键改用自增 ID + 冗余雪花 ID</strong>
保留雪花 ID 作为业务唯一标识（如订单号），但主键改用 MySQL 自增 ID，确保物理写入顺序性。</p> <div class="language- extra-class"><pre class="language-text"><code>CREATE TABLE orders (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,  -- 自增主键，保证物理有序
  order_no BIGINT UNSIGNED NOT NULL,    -- 雪花算法生成的业务 ID
  user_id BIGINT NOT NULL,
  create_time DATETIME NOT NULL,
  INDEX idx_order_no (order_no),
  INDEX idx_create_time (create_time)
) ENGINE=InnoDB;
</code></pre></div></li></ul> <p><strong>效果</strong></p> <ul><li>写入吞吐量提升  <strong>40%</strong> （索引分裂减少）。</li> <li>业务层仍可通过 <code>order_no</code> 保证分布式唯一性。</li></ul> <hr> <h5 id="_2-分库分表-id-冲突-worker-id-分配"><a href="#_2-分库分表-id-冲突-worker-id-分配" class="header-anchor">#</a> <strong>2. 分库分表 ID 冲突（Worker ID 分配）</strong></h5> <p><strong>问题分析</strong>
手动配置 <code>worker_id</code>，扩容时因运维误操作导致两个分片使用相同的 <code>worker_id</code>，生成重复订单号。</p> <p><strong>解决方案</strong></p> <ul><li><p><strong>动态 Worker ID 分配</strong>
服务启动时，通过 ZooKeeper 临时节点申请 <code>worker_id</code>，确保全局唯一：</p> <div class="language- extra-class"><pre class="language-text"><code>// 伪代码：基于 ZooKeeper 的 Worker ID 分配
public class SnowflakeWorker {
    private int workerId;

    public SnowflakeWorker() {
        String path = &quot;/snowflake/workers&quot;;
        // 在 ZooKeeper 上创建临时顺序节点，返回序号作为 workerId
        String node = zk.create(path + &quot;/worker-&quot;, EPHEMERAL_SEQUENTIAL);
        this.workerId = extractWorkerIdFromNode(node);  // 如节点名为 worker-0003，则 workerId=3
    }
}
</code></pre></div></li></ul> <p><strong>效果</strong></p> <ul><li>彻底避免 <code>worker_id</code> 冲突，支持动态扩容缩容。</li></ul> <hr> <h5 id="_3-时间范围查询优化"><a href="#_3-时间范围查询优化" class="header-anchor">#</a> <strong>3. 时间范围查询优化</strong></h5> <p><strong>问题分析</strong>
运营需查询 <code>2023-10-01 至 2023-10-02</code> 的订单，但直接通过雪花 ID 解析时间戳需全表扫描：</p> <div class="language- extra-class"><pre class="language-text"><code>-- 低效查询（需解析 ID 的时间戳）
SELECT * FROM orders 
WHERE (order_no &gt;&gt; 22) BETWEEN start_timestamp AND end_timestamp;
</code></pre></div><p><strong>解决方案</strong></p> <ul><li><p><strong>显式存储时间字段 + 复合索引</strong>
冗余 <code>create_time</code> 字段，并建立 <code>(create_time, order_no)</code> 索引：</p> <div class="language- extra-class"><pre class="language-text"><code>ALTER TABLE orders ADD INDEX idx_time_order (create_time, order_no);
</code></pre></div><p>查询时直接利用时间字段过滤：</p> <div class="language- extra-class"><pre class="language-text"><code>-- 高效查询（命中索引）
SELECT * FROM orders 
WHERE create_time BETWEEN '2023-10-01' AND '2023-10-02'
ORDER BY create_time, order_no LIMIT 1000;
</code></pre></div></li></ul> <p><strong>效果</strong></p> <ul><li>时间范围查询耗时从 <strong>2.5 秒</strong> 降至  <strong>50 毫秒</strong> 。</li></ul> <hr> <h5 id="_4-分页查询优化-游标分页"><a href="#_4-分页查询优化-游标分页" class="header-anchor">#</a> <strong>4. 分页查询优化（游标分页）</strong></h5> <p><strong>问题分析</strong>
用户查看历史订单时，传统分页 <code>LIMIT 1000000, 10</code> 需遍历大量无效数据。</p> <p><strong>解决方案</strong></p> <ul><li><p><strong>基于自增主键的游标分页</strong>
前端传递最后一条记录的 <code>id</code>，后端通过 <code>WHERE id &gt; {last_id}</code> 实现高效分页：</p> <div class="language- extra-class"><pre class="language-text"><code>-- 第一页
SELECT * FROM orders 
WHERE user_id = 123 
ORDER BY id ASC 
LIMIT 10;

-- 后续页（前端传递 last_max_id=100）
SELECT * FROM orders 
WHERE user_id = 123 AND id &gt; 100 
ORDER BY id ASC 
LIMIT 10;
</code></pre></div></li></ul> <p><strong>效果</strong></p> <ul><li>分页查询耗时从 <strong>3 秒</strong> 降至  <strong>10 毫秒</strong> 。</li></ul> <hr> <h5 id="_5-时间回拨容错"><a href="#_5-时间回拨容错" class="header-anchor">#</a> <strong>5. 时间回拨容错</strong></h5> <p><strong>问题分析</strong>
某次服务器时钟同步异常，导致生成重复订单号，引发数据不一致。</p> <p><strong>解决方案</strong></p> <ul><li><p><strong>时钟监控 + 异常等待</strong>
在雪花算法代码中增加时钟回拨检测，若回拨时间小于阈值（如 100ms），则等待时钟追平：</p> <div class="language- extra-class"><pre class="language-text"><code>public synchronized long nextId() {
    long currentTimestamp = System.currentTimeMillis();
    if (currentTimestamp &lt; lastTimestamp) {
        long offset = lastTimestamp - currentTimestamp;
        if (offset &lt;= 100) {
            Thread.sleep(offset);  // 等待时钟追平
            currentTimestamp = System.currentTimeMillis();
        } else {
            throw new RuntimeException(&quot;Clock moved backwards!&quot;);
        }
    }
    // ...正常生成逻辑
}
</code></pre></div></li></ul> <p><strong>效果</strong></p> <ul><li>避免因时钟回拨导致的数据冲突，系统可用性提升。</li></ul> <hr> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> <strong>总结</strong></h4> <p>通过上述优化，该电商订单系统实现了：</p> <ol><li>写入性能提升  <strong>40%</strong> ，分页查询耗时降低  <strong>99%</strong> 。</li> <li>彻底解决分库分表后的 ID 冲突问题。</li> <li>时间范围查询效率提升  <strong>50 倍</strong> 。</li> <li>系统具备时钟回拨容错能力，保障数据一致性。</li></ol> <p><strong>技术选型对比</strong></p> <table><thead><tr><th>组件/策略</th> <th>优化前</th> <th>优化后</th></tr></thead> <tbody><tr><td>主键设计</td> <td>雪花 ID 作为主键</td> <td>自增主键 + 雪花 ID 冗余</td></tr> <tr><td>Worker ID 分配</td> <td>手动配置</td> <td>ZooKeeper 动态分配</td></tr> <tr><td>分页查询</td> <td>LIMIT OFFSET</td> <td>游标分页（基于自增 ID）</td></tr> <tr><td>时间范围查询</td> <td>解析雪花 ID 时间戳</td> <td>显式时间字段 + 复合索引</td></tr></tbody></table> <p>通过结合业务需求（高并发写入、分布式扩展、高效查询），选择针对性优化策略，实现性能与稳定性的平衡。</p> <h2 id="面试场景题-mysql分库分表性能优化"><a href="#面试场景题-mysql分库分表性能优化" class="header-anchor">#</a> <strong>面试场景题：MySQL分库分表性能优化</strong></h2> <p><strong>场景描述：</strong>
某电商平台的订单表采用分库分表设计，分为16个库，每个库64张表，分片键为用户ID的哈希值。随着业务增长，出现以下问题：</p> <ul><li>用户查询自己的订单列表时响应时间变长。</li> <li>运营按时间范围统计订单的查询性能极差。</li> <li>高峰期部分分库负载过高，导致延迟增加。</li></ul> <p><strong>问题分析及优化方案：</strong></p> <ol><li><strong>用户订单查询响应时间长</strong> <strong>原因分析：</strong></li></ol> <ul><li>索引缺失：用户查询订单时可能基于用户ID和时间排序，若分片内未建立 (user_id, create_time) 的联合索引，会导致全表扫描。</li> <li>数据倾斜：某些用户订单量极大，导致其所在分片数据量远超其他分片，查询效率下降。</li> <li>分片键限制：仅用用户ID哈希分片，未考虑时间维度，可能导致单分片内数据冷热不均。</li></ul> <p><strong>优化方案：</strong></p> <ul><li><strong>联合索引优化：</strong>
在每个分片表中创建 (user_id, create_time) 的联合索引，加速排序和过滤。</li></ul> <div class="language- extra-class"><pre class="language-text"><code>ALTER TABLE orders_${shard} ADD INDEX idx_user_time (user_id, create_time);
</code></pre></div><ul><li><strong>冷热数据分离：</strong>
将历史订单（如6个月前）归档到独立的历史库，减少当前分片的数据量。</li> <li><strong>动态分片调整：</strong>
对超高频用户（如大卖家）单独分片或采用用户ID+时间复合分片键，分散压力。</li></ul> <ol start="2"><li><strong>时间范围统计查询性能差</strong> <strong>原因分析：</strong>
时间范围查询需跨所有分片扫描数据，导致大量IO和网络开销，且无法利用分片键直接定位。</li></ol> <p><strong>优化方案：</strong></p> <ul><li><strong>异步ETL到分析型数据库：</strong>
将订单数据同步至列式存储数据库（如ClickHouse）或Elasticsearch，专用于复杂查询。</li></ul> <div class="language- extra-class"><pre class="language-text"><code># 使用DataX或Canal同步数据
canal.adapter -&gt; ClickHouse
</code></pre></div><ul><li><strong>时间分片冗余</strong> ：</li></ul> <p>在分库分表基础上，按月份分片（如 <code>order_202310</code>），结合用户ID哈希，实现双维度分片。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 分片策略伪代码：userHash % 16 + 时间戳前缀（如202310）</span>
<span class="token class-name">String</span> shardKey <span class="token operator">=</span> userIdHash <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> timestampPrefix<span class="token punctuation">;</span>
</code></pre></div><ul><li><strong>并行查询聚合：</strong>
在应用层并行查询所有分片，合并结果后返回，减少串行延迟。</li></ul> <div class="language- extra-class"><pre class="language-text"><code>CompletableFuture&lt;List&lt;Order&gt;&gt; future1 = queryShard(shard1, startTime, endTime);
CompletableFuture&lt;List&lt;Order&gt;&gt; future2 = queryShard(shard2, startTime, endTime);
// ...合并所有结果
</code></pre></div><h4 id="高峰期部分分库负载过高"><a href="#高峰期部分分库负载过高" class="header-anchor">#</a> <strong>高峰期部分分库负载过高</strong></h4> <p><strong>原因分析：</strong></p> <ul><li>哈希不均匀：用户ID哈希分布不均，导致某些分片数据量或请求量过高。</li> <li>热点用户：少数高频用户集中访问同一分片。</li></ul> <p>优化方案：</p> <ul><li><strong>一致性哈希优化：</strong>
采用一致性哈希算法替代简单哈希，扩容时仅迁移部分数据，减少负载波动。</li> <li><strong>动态负载均衡</strong> ：
监控分片负载，自动迁移热点数据至空闲分片。</li> <li><strong>本地缓存+限流</strong> ：
对热点用户订单数据缓存到Redis，并设置限流策略（如令牌桶），防止击穿数据库。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6c5e603f.js" defer></script><script src="/assets/js/2.b8f1ea19.js" defer></script><script src="/assets/js/1.1af8b773.js" defer></script><script src="/assets/js/105.fe40214d.js" defer></script>
  </body>
</html>
